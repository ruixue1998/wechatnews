# 工作流的名称，将显示在 Actions 标签页
name: wechatnews

on:
  # 定时触发：每天 UTC 时间 0 点 0 分（即北京时间早上 8 点）
  schedule:
    - cron: '0 0 * * *'
  # 允许手动触发
  workflow_dispatch:

jobs:
  fetch_article:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Fetch latest article
        id: fetch
        env:
          # ↓↓↓ 把这里的值换成您在第一步中获取的 __biz 值 ↓↓↓
          BIZ: 'MjM5MjAyNDUyMA=='
        run: |
          import os
          import requests
          import json

          biz = os.environ['BIZ']
          url = f"https://weread.111965.xyz/api/v1/feeds/articles/{biz}?recent=1"

          try:
            response = requests.get(url, timeout=60)
            response.raise_for_status()
            data = response.json()

            if data and 'items' in data and data['items']:
              latest_article = data['items'][0]
              title = latest_article.get('title', 'No Title')
              link = latest_article.get('url', 'No URL')
              print(f"公众号: {data.get('title', 'Unknown')}")
              print(f"最新文章标题: {title}")
              print(f"最新文章链接: {link}")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  print(f'article_title={title}', file=f)
                  print(f'article_link={link}', file=f)
            else:
              print("未能获取到文章。")

          except Exception as e:
            print(f"发生错误: {e}")
            exit(1)

      - name: Print fetched article info
        run: |
          echo "获取到的文章标题是: ${{ steps.fetch.outputs.article_title }}"
          echo "获取到的文章链接是: ${{ steps.fetch.outputs.article_link }}"
