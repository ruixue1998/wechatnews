name: wechatnews

on:
  schedule:
    # 每天北京时间早上 8 点运行
    - cron: '0 0 * * *'
  # 允许手动触发
  workflow_dispatch:

jobs:
  fetch_article:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Fetch latest article
        id: fetch
        # 直接使用 python shell 来运行下面的代码块，更稳定
        shell: python
        env:
          # ↓↓↓ 确保这里是你自己的 __biz 值 ↓↓↓
          BIZ: 'MjM5MjAyNDUyMA=='
        run: |
          import os
          import requests
          import json
          import sys

          biz = os.environ.get('BIZ')
          url = f'https://weread.111965.xyz/api/v1/feeds/articles/{biz}?recent=1'

          try:
            print(f"正在请求 URL: {url}")
            response = requests.get(url, timeout=60)
            # 如果 HTTP 状态码不是 2xx，则会在此处抛出异常
            response.raise_for_status()
            
            # 尝试解析 JSON
            data = response.json()

            if data and 'items' in data and data['items']:
              latest_article = data['items'][0]
              title = latest_article.get('title', 'No Title')
              link = latest_article.get('url', 'No URL')
              print(f"公众号: {data.get('title', 'Unknown')}")
              print(f"最新文章标题: {title}")
              print(f"最新文章链接: {link}")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  print(f'article_title={title}', file=f)
                  print(f'article_link={link}', file=f)
            else:
              print('未能获取到文章，API 返回数据为空或格式不符。')
              sys.exit(1)

          except requests.exceptions.RequestException as e:
            print(f'网络或HTTP请求错误: {e}', file=sys.stderr)
            sys.exit(1)
          except json.JSONDecodeError as e:
            print(f'JSON解析错误: {e}', file=sys.stderr)
            print(f'收到的非JSON内容: {response.text}', file=sys.stderr)
            sys.exit(1)
          except Exception as e:
            print(f'发生未知错误: {e}', file=sys.stderr)
            sys.exit(1)
